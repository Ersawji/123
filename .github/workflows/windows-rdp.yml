name: Windows RDP (Debugged)

on:
  workflow_dispatch:

jobs:
  rdp-runner:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 hours max

    steps:
    # 1. Checkout Code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Install VB-Cable (Audio Fix) - ERROR PROOFED
    - name: Install Audio Driver (VB-Cable)
      run: |
        # Install the virtual audio driver
        choco install vb-cable -y
        
        # Try to start the Windows Audio service, but don't crash if it fails
        Set-Service -Name Audiosrv -StartupType Automatic
        Start-Service -Name Audiosrv -ErrorAction SilentlyContinue
        
        Write-Host "Audio driver installation attempted."
      continue-on-error: true # <--- CRITICAL FIX: This keeps the runner alive even if audio fails

    # 3. Setup Chrome Remote Desktop
    - name: Setup Chrome Remote Desktop
      env:
        CRD_CMD: ${{ secrets.CRD_POWER_SHELL_COMMAND }}
      run: |
        # Check if the secret exists first
        if (-not $env:CRD_CMD) {
          Write-Error "Error: The secret CRD_POWER_SHELL_COMMAND is missing!"
          exit 1
        }

        # Run the command
        Invoke-Expression $env:CRD_CMD
        
        Write-Host "Chrome Remote Desktop installed successfully."

    # 4. Keep Alive Loop
    - name: Keep Runner Alive
      run: |
        Write-Host "--------------------------------------------------------"
        Write-Host "SUCCESS! You can now connect."
        Write-Host "Go to: https://remotedesktop.google.com/access"
        Write-Host "--------------------------------------------------------"
        
        $seconds = 21600 # 6 hours
        while ($seconds -gt 0) {
          Start-Sleep -Seconds 60
          $seconds -= 60
          Write-Host "Runner is active. Time remaining: $([math]::Round($seconds / 60)) minutes..."
        }
        
