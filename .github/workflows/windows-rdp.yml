name: Windows RDP (Universal Fix)

on:
  workflow_dispatch:

jobs:
  rdp-runner:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # 1. Checkout Code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Install Audio Driver (VB-Cable)
    - name: Install Audio Driver
      run: |
        choco install vb-cable -y
        Set-Service -Name Audiosrv -StartupType Automatic
        Start-Service -Name Audiosrv -ErrorAction SilentlyContinue
      continue-on-error: true

    # 3. ROBUST INSTALL CHROME REMOTE DESKTOP
    - name: Download and Install CRD (Multi-Mirror)
      run: |
        $userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        $output = "crd.msi"
        
        # LIST OF MIRRORS TO TRY
        $urls = @(
          "https://dl.google.com/remote_desktop/chromeremotedesktophost.msi",
          "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi",
          "https://dl.google.com/livedownload/chromeremotedesktophost.msi"
        )
        
        $downloaded = $false
        
        foreach ($url in $urls) {
            if (-not $downloaded) {
                Write-Host "Trying to download from: $url"
                try {
                    Invoke-WebRequest -Uri $url -OutFile $output -UserAgent $userAgent -ErrorAction Stop
                    if (Test-Path $output) {
                        $size = (Get-Item $output).Length
                        if ($size -gt 1000000) { # Verify file is > 1MB (not a corrupted 404 page)
                            Write-Host "Success! Downloaded from $url ($size bytes)"
                            $downloaded = $true
                        }
                    }
                } catch {
                    Write-Host "Failed to download from $url. Trying next..."
                }
            }
        }
        
        if (-not $downloaded) {
            Write-Error "CRITICAL: All download mirrors failed. Google may have changed the URL again."
            exit 1
        }
        
        Write-Host "Installing MSI..."
        Start-Process msiexec.exe -ArgumentList "/i $output /qn /norestart" -Wait
        Write-Host "Installation complete."

    # 4. Configure Chrome Remote Desktop
    - name: Configure and Start CRD
      env:
        CRD_CMD: ${{ secrets.CRD_POWER_SHELL_COMMAND }}
      run: |
        if (-not $env:CRD_CMD) {
          Write-Error "Error: CRD_POWER_SHELL_COMMAND secret is missing!"
          exit 1
        }
        Invoke-Expression $env:CRD_CMD

    # 5. Keep Alive (6 Hours)
    - name: Keep Runner Alive
      run: |
        Write-Host "--------------------------------------------------------"
        Write-Host "SUCCESS! You can now connect."
        Write-Host "Go to: https://remotedesktop.google.com/access"
        Write-Host "--------------------------------------------------------"
        $seconds = 21600
        while ($seconds -gt 0) {
          Start-Sleep -Seconds 60
          $seconds -= 60
          Write-Host "Time remaining: $([math]::Round($seconds / 60)) minutes..."
        }
